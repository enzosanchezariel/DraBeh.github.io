import{c as G,a,t as i}from"../chunks/disclose-version.D9m7xwQo.js";import{p as Z,k as f,m as ee,f as u,a as te,i as e,j as t,s as h,l as oe,c as re,r as ae}from"../chunks/runtime.DfkX_MRI.js";import{i as d}from"../chunks/if.Che8I7_Z.js";import{e as se,i as ne}from"../chunks/each.CjdCHN41.js";import{p as v}from"../chunks/proxy.DjRACbVb.js";import{s as ie,a as le}from"../chunks/store.F8uOMCsi.js";import{P as O}from"../chunks/public.CuSQJZaf.js";import{F as U}from"../chunks/FeedPost.DRi3hJmN.js";import{o as pe}from"../chunks/index-client.D7pkVx_0.js";import{p as me}from"../chunks/stores.Cui5S3t7.js";import{o as fe,g as k}from"../chunks/entry.DrjQL-hL.js";import{i as H,j as J}from"../chunks/jwtRetriever.svelte.DgyyIg0v.js";import{b as q}from"../chunks/paths.Yc6EZHTJ.js";var de=i("<p>Post not found</p>"),ce=i("<p>Loading post...</p>"),ue=i("<p>Failed to load post</p>"),ve=i('<h3>Replying to</h3> <!> <div class="vertical-line svelte-10uk3rb"></div>',1),_e=i("<!> <!>",1),ge=i('<div class="comment"><!></div>'),he=i("<p>No comments</p>"),ye=i("<hr> <h3>Comments</h3> <!> <!>",1),we=i("<p>Loading comments...</p>"),Ce=i("<p>Failed to load comments</p>"),Pe=i("<!> <!> <!>",1);function Me(Q,V){Z(V,!0);const W=ie();let E=le(me,"$page",W).params.id,l=f(v([])),N=0,y=f(!1),R=f(!1),w=f(!1);async function z(){if(console.log("loadMore"),!(e(y)||e(R))){t(y,!0),t(w,!1);try{const o=await fetch(O+"/posts/comments/"+E+`?page=${N}&size=5`,{method:"GET",headers:H()?{Authorization:"Bearer "+J()}:{}}),r=await o.json();o.status!==200?t(w,!0):r.length!==0?(t(l,v([...e(l),...r])),N+=1):t(R,!0)}catch{t(w,!0)}t(y,!1)}}let j;function A(){if(j&&j.disconnect(),e(l).length>0){const o=document.querySelector(".comment:last-child");o&&(j=new IntersectionObserver(r=>{r[0].isIntersecting&&z()}),j.observe(o))}}pe(()=>{D(),e(F)||(z(),A())}),fe(o=>{var r,P,L,x;((r=o.to)==null?void 0:r.route.id)!=="/home/post/[id]"||((P=o.from)==null?void 0:P.route.id)!=="/home/post/[id]"||(console.log(o),E=((x=(L=o.to)==null?void 0:L.params)==null?void 0:x.id)??"-1",t(s,null),t(I,null),t(C,!1),t($,!1),t(l,v([])),N=0,t(y,!1),t(R,!1),t(w,!1),D(),e(F)||(z(),A()))}),ee(()=>{A()});let $=f(!0),C=f(!1),F=f(!1),s=f(null),I=f(null);async function D(){t($,!0),t(C,!1);try{const o=await fetch(O+"/post/"+E,{method:"GET",headers:H()?{Authorization:"Bearer "+J()}:{}});o.status!==200?(t(C,!0),o.status===404&&t(F,!0)):t(s,v(await o.json()))}catch{t(C,!0)}t($,!1),e(s)&&e(s).post.replyTo&&t(I,v(await K(e(s).post.replyTo)))}async function X(o){const r=await K(o);r&&t(l,v([r,...e(l)]))}async function K(o){const r=await fetch(O+"/post/"+o);return r.status===200?r.json():null}var S=G(),Y=u(S);d(Y,()=>e(F),o=>{var r=de();a(o,r)},o=>{var r=Pe(),P=u(r);d(P,()=>e($),m=>{var n=ce();a(m,n)},m=>{var n=G(),_=u(n);d(_,()=>e(C)||e(s)===null,c=>{var p=ue();a(c,p)},c=>{var p=_e(),g=u(p);d(g,()=>e(s).post.replyTo&&e(I),b=>{var B=ve(),M=h(u(B),2);U(M,{get post(){return e(I)},redirectOnClick:"true",replied:()=>{e(s)&&e(s).post.replyTo&&k(q+"/home/post/"+e(s).post.replyTo)},ondelete:()=>{k(q+"/home")}}),oe(2),a(b,B)});var T=h(g,2);U(T,{get post(){return e(s)},replied:b=>{X(b)},ondelete:()=>{k(q+"/home")}}),a(c,p)},!0),a(m,n)});var L=h(P,2);d(L,()=>e(s)&&e(s).post.replyTo===null,m=>{var n=ye(),_=h(u(n),4);se(_,17,()=>e(l),ne,(p,g)=>{var T=ge(),b=re(T);U(b,{get post(){return e(g)},ondelete:B=>{t(l,v(e(l).filter(M=>M.post.id!==B)))}}),ae(T),a(p,T)});var c=h(_,2);d(c,()=>e(l).length===0,p=>{var g=he();a(p,g)}),a(m,n)});var x=h(L,2);d(x,()=>e(y),m=>{var n=we();a(m,n)},m=>{var n=G(),_=u(n);d(_,()=>e(w),c=>{var p=Ce();a(c,p)},null,!0),a(m,n)}),a(o,r)}),a(Q,S),te()}export{Me as component};
